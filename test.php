<?php

ini_set('display_errors', 1);
error_reporting(E_ALL);

function splitAddresses(string $addressBlock): array
{
    if (empty(trim($addressBlock))) {
        return [];
    }

    $addressBlock = trim($addressBlock);
    $addressBlock = preg_replace(['/\s+/', '/([,.])\1+/'], [' ', '$1'], $addressBlock);

    // Предварительная обработка составных маркеров, чтобы они стали одним токеном
    $addressBlock = preg_replace('/р\.\s*п\./i', 'рп.', $addressBlock);

    $parts = preg_split('/[;\r\n]+/', $addressBlock);
    if (count($parts) > 1) {
        $allAddresses = [];
        foreach ($parts as $part) {
            $allAddresses = array_merge($allAddresses, splitAddresses(trim($part)));
        }
        return array_values(array_unique($allAddresses));
    }

    $delimiter = 'Российская Федерация';
    if (substr_count(mb_strtolower($addressBlock), mb_strtolower($delimiter)) > 1) {
        $parts = preg_split("/(" . preg_quote($delimiter, '/') . ")/i", $addressBlock, -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY);
        $addresses = [];
        $currentAddress = '';
        foreach ($parts as $part) {
            if (mb_strtolower(trim($part)) === mb_strtolower($delimiter)) {
                if (!empty(trim($currentAddress))) {
                    $addresses = array_merge($addresses, splitAddresses(trim($currentAddress)));
                }
                $currentAddress = $part;
            } else {
                $currentAddress .= $part;
            }
        }
        if (!empty(trim($currentAddress))) {
            $addresses = array_merge($addresses, splitAddresses(trim($currentAddress)));
        }
        return array_values(array_unique($addresses));
    }

    // --- Машина состояний ---
    
    $preparedBlock = str_replace(',', ' , ', $addressBlock);
    $preparedBlock = preg_replace('~(\S\.)([^\s.])~u', '$1 $2', $preparedBlock);
    $preparedBlock = trim(preg_replace('/\s+/', ' ', $preparedBlock));
    $tokens = explode(' ', $preparedBlock);

    // Разделяем типы населенных пунктов на основные и вложенные
    $majorLocalityTypes = ['г', 'с', 'п', 'рп', 'пгт', 'село', 'город', 'деревня', 'станица', 'поселок'];
    $subLocalityTypes = ['мкр', 'мкрн'];
    $localityTypes = array_merge($majorLocalityTypes, $subLocalityTypes); // Общий список для идентификации
    
    $streetTypes = ['ул', 'улица', 'пр', 'пр-т', 'проспект', 'пер', 'переулок', 'наб', 'набережная', 'б-р', 'бульвар', 'площадь', 'пл', 'ш', 'шоссе', 'пр-д', 'проезд', 'линия', 'кан', 'тер'];
    $housePartTypes = ['д', 'дом', 'корп', 'к', 'стр', 'строение', 'литера', 'лит'];
    $allMarkers = array_merge($localityTypes, $streetTypes, $housePartTypes);

    $prefix = '';
    $firstMarkerIndex = -1;
    foreach ($tokens as $i => $token) {
        if (in_array(rtrim($token, '.'), $allMarkers)) {
            $firstMarkerIndex = $i;
            break;
        }
    }

    if ($firstMarkerIndex != -1) {
        $startIndex = $firstMarkerIndex;
        while ($startIndex > 0 && $tokens[$startIndex - 1] !== ',') {
            $startIndex--;
        }
        if ($startIndex > 0) {
            $prefixTokens = array_slice($tokens, 0, $startIndex);
            $prefix = implode(' ', $prefixTokens);
            $tokens = array_slice($tokens, $startIndex);
        }
    } else {
        return [buildAddress('', $tokens)];
    }

    $finalAddresses = [];
    $currentAddressParts = [];
    
    $localityContextParts = [];
    $localityContextIsValid = false;
    $hasSeenLocality = false;
    $hasSeenStreet = false;
    $hasSeenHousePart = false;
    $addressPartCompleted = false;

    foreach ($tokens as $token) {
        $cleanToken = rtrim($token, '.');
        
        $isLocality = in_array($cleanToken, $localityTypes);
        $isMajorLocality = in_array($cleanToken, $majorLocalityTypes);
        $isStreet = in_array($cleanToken, $streetTypes);
        $isHousePart = in_array($cleanToken, $housePartTypes);
        $isMarker = $isLocality || $isStreet || $isHousePart;

        $startNewAddress = false;
        $splitByLocality = false;
        if (!empty($currentAddressParts)) {
            // Правило 1 (Астрахань): Новый ОСНОВНОЙ город после улицы или любого другого города
            if ($isMajorLocality && ($hasSeenStreet || $hasSeenLocality)) {
                $startNewAddress = true;
                $splitByLocality = true;
            }
            if (!$startNewAddress && $addressPartCompleted && ($isStreet || (!$isMarker && $token !== ','))) {
                 $startNewAddress = true;
            }
            if (!$startNewAddress && $isStreet && $hasSeenHousePart) {
                $startNewAddress = true;
            }
        }

        if ($startNewAddress) {
            $finalAddresses[] = buildAddress($prefix, $currentAddressParts);
            
            if ($splitByLocality) {
                $currentAddressParts = [];
                $localityContextParts = [];
                $localityContextIsValid = false;
            } else {
                $currentAddressParts = $localityContextIsValid ? $localityContextParts : [];
            }

            $hasSeenLocality = $localityContextIsValid;
            $hasSeenStreet = false;
            $hasSeenHousePart = false;
            $addressPartCompleted = false;
        }

        $currentAddressParts[] = $token;

        if ($isLocality) $hasSeenLocality = true;
        if ($isStreet) $hasSeenStreet = true;
        if ($isHousePart) $hasSeenHousePart = true;

        if (!$hasSeenStreet) {
            $localityContextParts[] = $token;
            if ($isLocality) {
                $localityContextIsValid = true;
            }
        }

        if ($token === ',' && $hasSeenHousePart) {
            $addressPartCompleted = true;
        } elseif ($hasSeenHousePart) {
            $addressPartCompleted = false;
        }
    }

    if (!empty($currentAddressParts)) {
        $finalAddresses[] = buildAddress($prefix, $currentAddressParts);
    }

    return array_values(array_unique($finalAddresses));
}

function buildAddress(string $prefix, array $parts): string {
    $address = $prefix . ' ' . implode(' ', $parts);
    $address = trim($address);
    $address = preg_replace('/\s*,\s*/', ', ', $address);
    $address = preg_replace('/ ,/', ',', $address);
    $address = preg_replace(['/\s*,\s*$/', '/\s+/'], ['', ' '], $address);
    echo "  -> СОБРАН АДРЕС: " . $address . "\n";
    return $address;
}

// =============================================================================
// ТЕСТОВЫЕ ДАННЫЕ
// =============================================================================
$testCases = [
    "Случай Андрея (Грибоедова)" => "Российская Федерация, Нижегородская обл, Дзержинск г, ул.Чапаева, д.58\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Суворова, д.2\nРоссийская Федерация, Нижегородская обл, Дзержинск г, б-р Мира, д.40\nРоссийская Федерация, Нижегородская обл, Дзержинск г, б-р Мира, д.31\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Грибоедова, д.41\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Грибоедова, д.33\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Маяковского, д.15\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Маяковского, д.13\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Маяковского, д.8\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Маяковского, д.20\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Ленина, д.2а\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул..Чапаева, д.33\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул..Чапаева, д.46а\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Гайдара, д.27/13\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Грибоедова, д.7\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Маяковского, д.22\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Революции, д.18\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Грибоедова, д.27\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Попова, д.14\nРоссийская Федерация, Нижегородская обл, Дзержинск г, б-р Мира, д.17\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Ленинского Комсомола, д.32\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Циолковского, д.70\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Галкина, д..2/38\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Октябрьская, д.24\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Октябрьская, д.28\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Ленина, д..61\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул..Гагарина, д.10 /5\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Циолковского, д.26\nРоссийская Федерация, Нижегородская обл, Дзержинск г, ул.Грибоедова, д.30\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Циолковского, д.45\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Циолковского, д.45б\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Ленина, д.105\nРоссийская Федерация, Нижегородская обл, Дзержинск г, пр-т Чкалова, д.22/40",
    "Мой случай (Петербург)" => "Российская Федерация, Санкт-Петербург, 5-я Советская ул., д. 16 литера А, 8-я Советская ул., д. 15/24 литера А, Варшавская ул., д. 116 литера А, Варшавская ул., д. 14 литера А, Варшавская ул., д. 34 литера А, Конная ул., д. 10 литера Б, Новочеркасский пр., д. 40 литера А, Ставропольская ул., д. 1 литера А, Таллинская ул., д. 22 литера А, Фурштатская ул., д. 26 литера А, Фурштатская ул., д. 43 литера А, Фурштатская ул., д. 54 литера А, Чайковского ул., д. 39 литера Б,\n",
    "Кейс Алёны" => "Российская Федерация, Астраханская обл, г. Знаменск, ул. Волгоградская, 30 г. Знаменск, ул. Янгеля, 19 г. Камызяк, ул. Тулайкова, 9 г. Нариманов, ул. Астраханская, 7 г. Харабали, ул. Пирогова, 9 г. Харабали, ул. Советская, 110 п. Володарский, ул. Мичурина, 8 п. Стеклозавода, ул. Гоголя, 6 п. Стеклозавода, ул. Гоголя, 8 п. Стеклозавода, ул. Карла Маркса, 1 п. Стеклозавода, ул. Ленина, 18 п. Стеклозавода, ул. Ленина, 19 п. Стеклозавода, ул. Пушкина, 1 п. Стеклозавода, ул. Пушкина, 3 п. Тинаки -2ые, ул. Санаторная, 4 п. Трусово, ул. Железнодорожная, 6 п. Трусово, ул. Школьная, 1, литер а п. Трусово, ул. Школьная, 10, литер А п. Трусово, ул. Школьная, 11 п. Трусово, ул. Школьная, 2, литер А п. Трусово, ул. Школьная, 3, литер А п. Трусово, ул. Школьная, 4, литер А п. Трусово, ул. Школьная, 5, литер А п. Трусово, ул. Школьная, 7, литер А п. Трусово, ул. Школьная, 8, литер А п. Трусово, ул. Школьная, 9, литер А\nРоссийская Федерация, Астраханская обл, р. п. Верхний Баскунчак, пер. Молодежный 4 р. п. Верхний Баскунчак, пер. Молодежный, 6 р. п. Верхний Баскунчак, пер. Октябрьский, 7 р. п. Верхний Баскунчак, ул. Джамбула, 12 р. п. Верхний Баскунчак, ул. Джамбула, 14 р. п. Верхний Баскунчак, ул. Карла Маркса, 13 р. п. Верхний Баскунчак, ул. Карла Маркса, 15 р. п. Верхний Баскунчак, ул. Карла Маркса, 9 р. п. Верхний Баскунчак, ул. Щетинкина, 63 р. п. Волго - Каспийский, ул. Волжская, 48 р. п. Волго - Каспийский, ул. Гоголя, 6 р. п. Волго - Каспийский, ул. Ленина, 3 р. п. Волго - Каспийский, ул. Ленина, 5\nРоссийская Федерация, Астраханская обл, р. п. Ильинка, ул. Лермонтова, 8 р. п. Лиман, ул. Кирова, 6 р. п. Лиман, ул. Кирова, 8 р. п. Лиман, ул. Космонавтов, 43 р. п. Лиман, ул. Космонавтов, 45 р. п. Лиман, ул. Космонавтов, 60 р. п. Лиман, ул. Кочубея, 40 р. п. Лиман, ул. Кочубея, 41 р. п. Лиман, ул. Ленина, 47 р. п. Лиман, ул. Ленина, 49 р. п. Лиман, ул. Мелиоративная, 3 р. п. Лиман, ул. Мелиоративная, 4 р. п. Лиман, ул. Мира, 1 р. п. Нижний Баскунчак, ул. 100 летие Солепромысла, 14 р. п. Нижний Баскунчак, ул. 100 летие Солепромысла, 16 р. п. Нижний Баскунчак, ул. Кирова, 1 р. п. Нижний Баскунчак, ул. Кирова, 2 р. п. Нижний Баскунчак, ул. Кирова, 3 р. п. Нижний Баскунчак, ул. Кирова, 5 р. п. Нижний Баскунчак, ул. Кирова, 7 р. п. Нижний Баскунчак, ул. Кирова, 8 р. п. Нижний Баскунчак, ул. М.Горького, 29 р. п. Нижний Баскунчак, ул. Озерная, 1 р.п. Красные Баррикады, ул. Баррикадная, 4 р.п. Красные Баррикады, ул. Мира, 3 р.п. Красные Баррикады, ул. Первомайская, 12 р.п. Красные Баррикады, ул. Первомайская, 13 р.п. Красные Баррикады, ул. Первомайская, 15\nРоссийская Федерация, Астраханская обл, с. Бирюковка, ул. Молодежная, 2 с. Бирюковка, ул. Молодежная, 8 с. Бирюковка, ул. Юбилейная, 10 с. Бирюковка, ул. Юбилейная, 11 с. Бирюковка, ул. Юбилейная, 12 с. Бирюковка, ул. Юбилейная, 13 с. Бирюковка, ул. Юбилейная, 9 с. Биштюбинка, ул. Советская, 139 с. Биштюбинка, ул. Советская, 141 с. Биштюбинка, ул. Советская, 143\nРоссийская Федерация, Астраханская обл, с. Восток, ул. Октябрьская, 1 с. Восток, ул. Октябрьская, 2 с. Восток, ул. Октябрьская, 3 с. Восточное, ул. Школьная, 8 с. Евпраксино, мкрн. Юность, 1 с. Енотаевка, ул. Заречная, 1 с. Енотаевка, ул. Мусаева, 38 с. Енотаевка, ул. Мусаева, 40 с. Енотаевка, ул. Мусаева, 42 с. Енотаевка, ул. Мусаева, 44 с. Енотаевка, ул. Мусаева, 46 с. Енотаевка, ул. Мусаева, 50 с. Енотаевка, ул. Мусаева, 52 с. Енотаевка, ул. Пушкина, 48 с. Енотаевка, ул. Пушкина, 50 с. Енотаевка, ул. Татищева, 44 с. Енотаевка, ул. Татищева, 65 с. Енотаевка, ул. Чичерина, 19\nРоссийская Федерация, Астраханская обл, с. Зензели, ул. Школьная, 4 с. Зензели, ул. Школьная, 6 с. Икряное, ул. Кирова,91а с. Икряное, ул. Кирова,91б с. Икряное, ул. Куйбышева,11 с. Икряное, ул. Куйбышева,13 с. Икряное, ул. Куйбышева,5 с. Красный Яр, ул. Карла Маркса, 49 с. Красный Яр, ул. Карла Маркса, 51 с. Красный Яр, ул. Ленинская, 39 с. Красный Яр, ул. Ленинская, 44 с. Красный Яр, ул. Ленинская, 45 с. Красный Яр, ул. Маячная, 43 с. Красный Яр, ул. Советская, 60 с. Мумра, ул. Крупской, 2\nРоссийская Федерация, Астраханская обл, с. Началово, ул. Куйбышева, 2, литер а с. Началово, ул. Победы, 18 с. Началово, ул. Победы, 2 с. Началово, ул. Победы, 4",
    "Кейс Алёны (новый)" => "Российская Федерация, Кемеровская область - Кузбасс обл, г. Кемерово,  пр-т. Шахтеров, д. 28, ул. Сибиряков-Гвардейцев, д. 328а, б-р. Строителей, д. 29а, пер. Волкова, д. 8, ул. Лядова, д. 5, ул. Лядова, д. 7, ул. Волгоградская, д. 31а, ул. Волгоградская, д. 32в, ул. Волгоградская, д. 34в пр-т. Ленина, д. 21"
];

// =============================================================================
// ЗАПУСК ТЕСТОВ
// =============================================================================
foreach ($testCases as $name => $data) {
    echo "=================================================================\n";
    echo "ЗАПУСК ТЕСТА: $name\n";
    echo "=================================================================\n";

    $result = splitAddresses($data);

    echo "\n--- РЕЗУЛЬТАТ РАЗБИВКИ (" . count($result) . " адресов) ---\n";
    foreach ($result as $address) {
        echo "- " . $address . "\n";
    }
    echo "\n\n";
}
