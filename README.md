# CRWatch: Telegram-бот для мониторинга закупок капитального ремонта

Проект `crwatch` представляет собой комплекс инструментов на PHP для сбора, обработки и анализа данных о закупках в сфере капитального ремонта с официального сайта `zakupki.gov.ru`. Результатом работы является Telegram-бот, предоставляющий удобный интерфейс для поиска закупок по адресу.

### Попробовать

https://t.me/majorrepairswatchbot

На 23.08.2025 хостинг оплачен на месяц, дальше работа пока не гарантируется.

В этой тестовой версии база пока только за 2025

### Ключевые возможности

*   **Автоматическая загрузка и парсинг** данных с сайта `zakupki.gov.ru`
*   **Интеллектуальное дробление** временных диапазонов при загрузке для обхода ограничений сайта
*   **Обогащение данных** путем скачивания детальной информации (включая адреса объектов) по каждой закупке
*   **Создание базы данных MySQL** на основе скачанных данных
*   **Умный поиск по адресам** в Telegram-боте с учетом сокращений и различных форматов написания
*   **Возобновляемая работа** самого долгого скрипта: в случае прерывания, процесс можно продолжить с того же места

## Системные требования

*   PHP 8.1 или выше
*   PHP модули: `php-cli`, `php-curl`, `php-xml`, `php-pdo_mysql`, `php-mbstring`
*   Сервер MySQL или MariaDB

## Другие требования

*   Извлечение данных работает только с российских IP

## Пошаговая инструкция по установке и запуску

### Шаг 1: Подготовка окружения

1.  **Клонируйте репозиторий** на ваш сервер или локальную машину:
    ```bash
    git clone [URL вашего репозитория]
    cd crwatch
    ```

2.  **Установите Composer**, если он не установлен глобально. Эта команда скачает его в текущую папку:
    ```bash
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    php composer-setup.php
    php -r "unlink('composer-setup.php');"
    ```

3.  **Установите PHP-зависимости** проекта:
    ```bash
    php ./composer.phar install
    ```

4.  **Создайте пустую базу данных** в MySQL.
    ```sql
    CREATE DATABASE zakupki_data CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    ```

5.  **Создайте файл конфигурации**. Скопируйте файл `config.php.example` в `config.php` и внесите в него свои данные:
    ```bash
    cp config.php.example config.php
    nano config.php 
    ```
    Вам нужно будет указать:
    *   Данные для подключения к базе данных (`DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS`).
    *   Токен вашего Telegram-бота (`BOT_TOKEN`).

### Шаг 2: Сбор и обработка данных

Эти скрипты нужно запускать последовательно, один за другим, из командной строки.

#### 1. Первоначальная выгрузка данных (`parser.php`)

Этот скрипт скачивает основную информацию о контрактах за указанный период.

*   **Настройка:** Откройте файл `parser.php` и установите нужный диапазон дат в блоке `$searchParams`. Например, для 2025 года:
    ```php
    'capitalDateOfContractConclusionFrom' => '01.01.2025',
    'capitalDateOfContractConclusionTo'   => '31.12.2025',
    ```
*   **Запуск:**
    ```bash
    php parser.php
    ```
*   **Результат:** В папке появится файл `contracts.json`. Процесс может занять много времени.

#### 2. Обогащение данных (`enrich_contracts.php`)

Этот скрипт проходит по `contracts.json`, для каждой закупки скачивает детальную информацию и сохраняет ее.

*   **Запуск:**
    ```bash
    php enrich_contracts.php
    ```
*   **Особенность:** Скрипт можно прерывать и запускать заново — он продолжит работу с того места, на котором остановился.
*   **Результат:** В папке появится файл `contracts_enriched.json`.

#### 3. Создание SQL-дампа (`create_dump.php`)

Скрипт преобразует обогащенные данные из `contracts_enriched.json` в структурированный SQL-файл.

*   **Запуск:**
    ```bash
    php create_dump.php
    ```
*   **Результат:** В папке появится файл `database_dump.sql`.

#### 4. Импорт дампа в базу данных

Эта команда загрузит все данные из дампа в вашу пустую базу данных.

*   **Запуск:**
    ```bash
    mysql -u ВАШ_ПОЛЬЗОВАТЕЛЬ -p ВАША_БАЗА_ДАННЫХ < database_dump.sql
    ```
    Пример:
    ```bash
    mysql -u root -p zakupki_data < database_dump.sql
    ```

#### 5. Миграция адресов (`migrate_addresses.php`)

**Это критически важный шаг!** Скрипт преобразует поле с адресами в отдельную таблицу, разделяя "склеенные" адреса для корректного поиска.

*   **Запуск (выполняется только один раз):**
    ```bash
    php migrate_addresses.php
    ```
*   **Результат:** Ваша база данных будет полностью готова к работе с ботом.

### Шаг 3: Запуск Telegram-бота на Shared-хостинге

Простой запуск `php bot.php &` ненадежен, так как процесс может быть "убит" хостингом. Правильный способ — использовать **Cron Job**, который будет следить за работой бота.

1.  **Создайте скрипт-запускатор.** В папке проекта создайте файл `launcher.sh` со следующим содержимым:

    ```sh
    #!/bin/bash
    
    # Путь к вашему проекту
    PROJECT_PATH="/путь/к/вашему/проекту/crwatch"
    
    # Имя основного скрипта бота
    BOT_SCRIPT="bot.php"
    
    # Проверяем, запущен ли уже процесс бота
    if ! pgrep -f "$BOT_SCRIPT" > /dev/null
    then
        # Если не запущен, переходим в директорию и запускаем его в фоновом режиме
        echo "Bot is not running. Starting..."
        cd "$PROJECT_PATH"
        nohup php "$BOT_SCRIPT" &
    fi
    ```
    **Не забудьте** указать правильный `PROJECT_PATH`.

2.  **Сделайте скрипт исполняемым:**
    ```bash
    chmod +x launcher.sh
    ```

3.  **Настройте Cron Job.** В панели управления вашего хостинга (cPanel, ISPmanager и т.д.) найдите раздел "Планировщик Cron" или "Cron Jobs". Добавьте новое задание, которое будет выполняться **каждую минуту**.

    *   **Команда для выполнения:**
        ```
        /путь/к/вашему/проекту/crwatch/launcher.sh >/dev/null 2>&1
        ```
    *   **Расписание:** `* * * * *` (каждую минуту)

    Выражение `>/dev/null 2>&1` отключает вывод логов на почту, чтобы не засорять ваш ящик. Все логи работы бота будут писаться в файл `bot.log`.

Теперь планировщик будет каждую минуту проверять, работает ли ваш бот. Если процесс был прерван, он автоматически его перезапустит.
Для перезагрузки бота используйте `pkill -f bot.php`

